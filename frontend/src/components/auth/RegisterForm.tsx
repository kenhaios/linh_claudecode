// Vietnamese Registration Form Component for Ha Linh Astrology Platform
import React, { useState, useEffect } from 'react';
import { 
  Form, 
  Input, 
  Button, 
  Select, 
  DatePicker, 
  Alert, 
  Typography, 
  Space, 
  Divider,
  Row,
  Col,
  Checkbox,
  Progress
} from 'antd';
import { 
  UserOutlined, 
  LockOutlined, 
  PhoneOutlined, 
  MailOutlined,
  CalendarOutlined,
  EnvironmentOutlined
} from '@ant-design/icons';
import { Link, useNavigate } from 'react-router-dom';
import { useAppDispatch, useAppSelector } from '../../hooks/redux';
import { registerUser } from '../../store/slices/authSlice';
import { validateVietnamesePhone, validateEmail, validateVietnameseName } from '../../utils/validation';
import { getVietnameseProvinces, getVietnameseDistricts } from '../../services/locationService';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { Option } = Select;

interface RegisterFormValues {
  name: string;
  email?: string;
  phone?: string;
  password: string;
  confirmPassword: string;
  dateOfBirth?: string;
  preferences: {
    language: 'vi' | 'en';
    timezone: string;
    theme: 'vietnamese-traditional' | 'light' | 'dark';
  };
  location?: {
    province?: string;
    district?: string;
  };
  agreeToTerms: boolean;
}

interface RegisterFormProps {
  onSuccess?: () => void;
  redirectTo?: string;
}

export const RegisterForm: React.FC<RegisterFormProps> = ({ onSuccess, redirectTo = '/verify' }) => {
  const [form] = Form.useForm();
  const [passwordStrength, setPasswordStrength] = useState(0);
  const [provinces, setProvinces] = useState<Array<{ code: number; name: string }>>([]);
  const [districts, setDistricts] = useState<Array<{ code: number; name: string }>>([]);
  const [hasEmail, setHasEmail] = useState(false);
  const [hasPhone, setHasPhone] = useState(false);
  
  const navigate = useNavigate();
  const dispatch = useAppDispatch();
  
  const { loading, error } = useAppSelector((state) => state.auth);

  // Load Vietnamese provinces on component mount
  useEffect(() => {
    const loadProvinces = async () => {
      try {
        const provincesData = await getVietnameseProvinces();
        setProvinces(provincesData);
      } catch (error) {
        console.error('Failed to load provinces:', error);
      }
    };
    
    loadProvinces();
  }, []);

  // Load districts when province changes
  const handleProvinceChange = async (provinceCode: number) => {
    try {
      const districtsData = await getVietnameseDistricts(provinceCode);
      setDistricts(districtsData);
      form.setFieldValue(['location', 'district'], undefined);
    } catch (error) {
      console.error('Failed to load districts:', error);
    }
  };

  // Calculate password strength
  const calculatePasswordStrength = (password: string) => {
    let strength = 0;
    
    if (password.length >= 8) strength += 25;
    if (/[a-z]/.test(password)) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/\d/.test(password)) strength += 25;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 25;
    
    return Math.min(strength, 100);
  };

  const handlePasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const password = e.target.value;
    const strength = calculatePasswordStrength(password);
    setPasswordStrength(strength);
  };

  const getPasswordStrengthColor = () => {
    if (passwordStrength < 50) return '#ff4d4f';
    if (passwordStrength < 75) return '#faad14';
    return '#52c41a';
  };

  const getPasswordStrengthText = () => {
    if (passwordStrength < 25) return 'R·∫•t y·∫øu';
    if (passwordStrength < 50) return 'Y·∫øu';
    if (passwordStrength < 75) return 'Trung b√¨nh';
    if (passwordStrength < 100) return 'M·∫°nh';
    return 'R·∫•t m·∫°nh';
  };

  const handleSubmit = async (values: RegisterFormValues) => {
    try {
      // Validate at least one contact method
      if (!values.email && !values.phone) {
        form.setFields([
          {
            name: 'email',
            errors: ['Ph·∫£i cung c·∫•p √≠t nh·∫•t m·ªôt trong hai: email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i']
          }
        ]);
        return;
      }

      // Dispatch register action
      const result = await dispatch(registerUser(values)).unwrap();

      if (result.success) {
        // Show success and redirect to verification
        form.resetFields();
        
        if (onSuccess) {
          onSuccess();
        } else {
          navigate(redirectTo);
        }
      }
    } catch (error: any) {
      console.error('Registration failed:', error);
      // Error will be handled by the auth slice and displayed in the component
    }
  };

  return (
    <div style={{ maxWidth: 600, margin: '0 auto', padding: '40px 20px' }}>
      <div style={{ textAlign: 'center', marginBottom: 32 }}>
        <Title level={2} style={{ color: '#d32f2f', marginBottom: 8 }}>
          üåü ƒêƒÉng K√Ω T√†i Kho·∫£n
        </Title>
        <Text type="secondary">
          Tham gia c·ªông ƒë·ªìng Ha Linh - Kh√°m ph√° v·∫≠n m·ªánh c·ªßa b·∫°n
        </Text>
      </div>

      {error && (
        <Alert
          message="ƒêƒÉng k√Ω th·∫•t b·∫°i"
          description={error}
          type="error"
          showIcon
          style={{ marginBottom: 24 }}
          closable
        />
      )}

      <Form
        form={form}
        name="register"
        layout="vertical"
        onFinish={handleSubmit}
        autoComplete="off"
        size="large"
        initialValues={{
          preferences: {
            language: 'vi',
            timezone: 'Asia/Ho_Chi_Minh',
            theme: 'vietnamese-traditional'
          }
        }}
      >
        {/* Basic Information */}
        <Title level={4} style={{ color: '#d32f2f', marginBottom: 16 }}>
          üìù Th√¥ng tin c∆° b·∫£n
        </Title>

        <Form.Item
          name="name"
          label="H·ªç v√† t√™n"
          rules={[
            { required: true, message: 'Vui l√≤ng nh·∫≠p h·ªç v√† t√™n!' },
            { min: 2, message: 'H·ªç v√† t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±!' },
            { max: 50, message: 'H·ªç v√† t√™n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±!' },
            {
              validator: (_, value) => {
                if (!value) return Promise.resolve();
                
                if (!validateVietnameseName(value)) {
                  return Promise.reject(new Error('H·ªç v√† t√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng (h·ªó tr·ª£ ti·∫øng Vi·ªát)'));
                }
                
                return Promise.resolve();
              }
            }
          ]}
        >
          <Input
            prefix={<UserOutlined />}
            placeholder="VD: Nguy·ªÖn VƒÉn A"
            autoComplete="name"
          />
        </Form.Item>

        <Row gutter={16}>
          <Col xs={24} sm={12}>
            <Form.Item
              name="email"
              label="Email (t√πy ch·ªçn)"
              rules={[
                {
                  validator: (_, value) => {
                    if (!value) {
                      setHasEmail(false);
                      return Promise.resolve();
                    }
                    
                    setHasEmail(true);
                    
                    if (!validateEmail(value)) {
                      return Promise.reject(new Error('Email kh√¥ng h·ª£p l·ªá'));
                    }
                    
                    return Promise.resolve();
                  }
                }
              ]}
            >
              <Input
                prefix={<MailOutlined />}
                placeholder="example@gmail.com"
                autoComplete="email"
              />
            </Form.Item>
          </Col>
          
          <Col xs={24} sm={12}>
            <Form.Item
              name="phone"
              label="S·ªë ƒëi·ªán tho·∫°i (t√πy ch·ªçn)"
              rules={[
                {
                  validator: (_, value) => {
                    if (!value) {
                      setHasPhone(false);
                      return Promise.resolve();
                    }
                    
                    setHasPhone(true);
                    
                    if (!validateVietnamesePhone(value)) {
                      return Promise.reject(new Error('S·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam kh√¥ng h·ª£p l·ªá'));
                    }
                    
                    return Promise.resolve();
                  }
                }
              ]}
            >
              <Input
                prefix={<PhoneOutlined />}
                placeholder="0901234567"
                autoComplete="tel"
              />
            </Form.Item>
          </Col>
        </Row>

        {!hasEmail && !hasPhone && (
          <Alert
            message="L∆∞u √Ω: Ph·∫£i cung c·∫•p √≠t nh·∫•t m·ªôt trong hai: email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i"
            type="warning"
            showIcon
            style={{ marginBottom: 16 }}
          />
        )}

        <Row gutter={16}>
          <Col xs={24} sm={12}>
            <Form.Item
              name="password"
              label="M·∫≠t kh·∫©u"
              rules={[
                { required: true, message: 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!' },
                { min: 8, message: 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±!' },
                {
                  pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
                  message: 'M·∫≠t kh·∫©u ph·∫£i ch·ª©a √≠t nh·∫•t m·ªôt ch·ªØ hoa, m·ªôt ch·ªØ th∆∞·ªùng v√† m·ªôt s·ªë!'
                }
              ]}
            >
              <Input.Password
                prefix={<LockOutlined />}
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·∫°nh"
                autoComplete="new-password"
                onChange={handlePasswordChange}
              />
            </Form.Item>
            
            {passwordStrength > 0 && (
              <div style={{ marginTop: -16, marginBottom: 16 }}>
                <Progress
                  percent={passwordStrength}
                  strokeColor={getPasswordStrengthColor()}
                  showInfo={false}
                  size="small"
                />
                <Text type="secondary" style={{ fontSize: 12 }}>
                  ƒê·ªô m·∫°nh: {getPasswordStrengthText()}
                </Text>
              </div>
            )}
          </Col>
          
          <Col xs={24} sm={12}>
            <Form.Item
              name="confirmPassword"
              label="X√°c nh·∫≠n m·∫≠t kh·∫©u"
              dependencies={['password']}
              rules={[
                { required: true, message: 'Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u!' },
                ({ getFieldValue }) => ({
                  validator(_, value) {
                    if (!value || getFieldValue('password') === value) {
                      return Promise.resolve();
                    }
                    return Promise.reject(new Error('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!'));
                  },
                }),
              ]}
            >
              <Input.Password
                prefix={<LockOutlined />}
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                autoComplete="new-password"
              />
            </Form.Item>
          </Col>
        </Row>

        {/* Optional Information */}
        <Divider />
        <Title level={4} style={{ color: '#d32f2f', marginBottom: 16 }}>
          üéØ Th√¥ng tin b·ªï sung (t√πy ch·ªçn)
        </Title>

        <Row gutter={16}>
          <Col xs={24} sm={12}>
            <Form.Item
              name="dateOfBirth"
              label="Ng√†y sinh"
            >
              <DatePicker
                prefix={<CalendarOutlined />}
                placeholder="Ch·ªçn ng√†y sinh"
                style={{ width: '100%' }}
                format="DD/MM/YYYY"
                disabledDate={(current) => {
                  const now = dayjs();
                  const minAge = now.subtract(13, 'year');
                  const maxAge = now.subtract(120, 'year');
                  return current && (current.isAfter(minAge) || current.isBefore(maxAge));
                }}
              />
            </Form.Item>
          </Col>
          
          <Col xs={24} sm={12}>
            <Form.Item
              name={['preferences', 'theme']}
              label="Giao di·ªán"
            >
              <Select placeholder="Ch·ªçn giao di·ªán">
                <Option value="vietnamese-traditional">üèÆ Truy·ªÅn th·ªëng Vi·ªát Nam</Option>
                <Option value="light">‚òÄÔ∏è S√°ng</Option>
                <Option value="dark">üåô T·ªëi</Option>
              </Select>
            </Form.Item>
          </Col>
        </Row>

        <Row gutter={16}>
          <Col xs={24} sm={12}>
            <Form.Item
              name={['location', 'province']}
              label="T·ªânh/Th√†nh ph·ªë"
            >
              <Select
                placeholder="Ch·ªçn t·ªânh/th√†nh ph·ªë"
                onChange={handleProvinceChange}
                showSearch
                filterOption={(input, option) =>
                  (option?.children as unknown as string)
                    ?.toLowerCase()
                    .includes(input.toLowerCase())
                }
              >
                {provinces.map(province => (
                  <Option key={province.code} value={province.code}>
                    {province.name}
                  </Option>
                ))}
              </Select>
            </Form.Item>
          </Col>
          
          <Col xs={24} sm={12}>
            <Form.Item
              name={['location', 'district']}
              label="Qu·∫≠n/Huy·ªán"
            >
              <Select
                placeholder="Ch·ªçn qu·∫≠n/huy·ªán"
                disabled={districts.length === 0}
                showSearch
                filterOption={(input, option) =>
                  (option?.children as unknown as string)
                    ?.toLowerCase()
                    .includes(input.toLowerCase())
                }
              >
                {districts.map(district => (
                  <Option key={district.code} value={district.code}>
                    {district.name}
                  </Option>
                ))}
              </Select>
            </Form.Item>
          </Col>
        </Row>

        {/* Terms Agreement */}
        <Form.Item
          name="agreeToTerms"
          valuePropName="checked"
          rules={[
            { required: true, message: 'B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng!' }
          ]}
        >
          <Checkbox>
            T√¥i ƒë·ªìng √Ω v·ªõi{' '}
            <Link to="/terms" style={{ color: '#d32f2f' }}>
              ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng
            </Link>{' '}
            v√†{' '}
            <Link to="/privacy" style={{ color: '#d32f2f' }}>
              Ch√≠nh s√°ch b·∫£o m·∫≠t
            </Link>{' '}
            c·ªßa Ha Linh
          </Checkbox>
        </Form.Item>

        <Form.Item>
          <Button
            type="primary"
            htmlType="submit"
            loading={loading}
            block
            style={{
              height: 48,
              fontSize: 16,
              fontWeight: 600,
              background: 'linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%)',
              border: 'none',
              borderRadius: 8
            }}
          >
            {loading ? 'ƒêang ƒëƒÉng k√Ω...' : 'üöÄ T·∫°o T√†i Kho·∫£n'}
          </Button>
        </Form.Item>

        <div style={{ textAlign: 'center' }}>
          <Text type="secondary">
            ƒê√£ c√≥ t√†i kho·∫£n?{' '}
            <Link to="/login" style={{ color: '#d32f2f', fontWeight: 600 }}>
              ƒêƒÉng nh·∫≠p ngay
            </Link>
          </Text>
        </div>
      </Form>

      {/* Vietnamese cultural elements */}
      <div style={{ 
        textAlign: 'center', 
        marginTop: 32, 
        padding: 16,
        background: 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)',
        borderRadius: 8,
        border: '1px solid #ffd54f'
      }}>
        <Text style={{ color: '#e65100', fontSize: 12 }}>
          üèÆ Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi gia ƒë√¨nh Ha Linh! üèÆ
        </Text>
      </div>
    </div>
  );
};

export default RegisterForm;